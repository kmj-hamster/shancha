<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <title>Burning Memory</title>
  <link rel="stylesheet" href="./src/styles/fonts.css">
  <link rel="stylesheet" href="./src/styles/main.css">
  <link rel="stylesheet" href="./css/opening.css">
  <link rel="stylesheet" href="./css/effects/deletion-animation.css">
  <link rel="stylesheet" href="./css/glitch-overlay.css">
  <link rel="stylesheet" href="./css/effects/boot-shutdown.css">
  <link rel="stylesheet" href="./css/subtitle.css">
  <link rel="stylesheet" href="./css/ending.css">
  <!-- è¯­è¨€é€‰æ‹©ç•Œé¢æ ·å¼ -->
  <link rel="stylesheet" href="./css/lang-select.css">
  <!-- CRT Theme - Loaded last to wrap everything -->
  <link rel="stylesheet" href="./css/crt-theme.css">
  <!-- å¿ƒç”µå›¾é¢æ¿å­—ä½“ï¼šæ‰‹å†™ä½“ + å“ç‰Œé“­ç‰Œ -->
  <link href="https://fonts.googleapis.com/css2?family=Caveat&family=Ma+Shan+Zheng&family=Orbitron:wght@500&family=Noto+Serif+SC:wght@400&display=swap" rel="stylesheet">

  <style>
    /* åˆå§‹éšè—ä¸»ç•Œé¢ */
    .app-container {
      display: none;
      opacity: 0;
    }

    .app-container.app-fade-in {
      display: flex;
      animation: app-fade-in 1s forwards;
    }

    @keyframes app-fade-in {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>
</head>

<body class="theme-search">

  <!-- æ‰‹æœºç«–å±æç¤ºï¼ˆAndroid ç”¨ï¼‰ -->
  <div class="mobile-rotate-hint">
    <div class="rotate-text-zh">è¯·å°†è®¾å¤‡æ—‹è½¬è‡³æ¨ªå±æ¨¡å¼</div>
    <div class="rotate-text-en">Please rotate your device to landscape</div>

    <!-- PWA å®‰è£…å¼•å¯¼ï¼ˆAndroid ç«–å±æ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="pwa-guide pwa-guide-android">
      <div class="pwa-guide-title">
        <span class="pwa-title-zh">è·å¾—æœ€ä½³ä½“éªŒ</span>
        <span class="pwa-title-en">For the best experience</span>
      </div>
      <div class="pwa-step">
        <span class="pwa-icon">&#8942;</span>
        <span class="pwa-text-zh">ç‚¹å‡»å³ä¸Šè§’ <strong>èœå•</strong> &#8942;</span>
        <span class="pwa-text-en">Tap <strong>Menu</strong> &#8942; (top right)</span>
      </div>
      <div class="pwa-step">
        <span class="pwa-icon">+</span>
        <span class="pwa-text-zh">é€‰æ‹© <strong>æ·»åŠ åˆ°ä¸»å±å¹•</strong></span>
        <span class="pwa-text-en">Select <strong>Add to Home Screen</strong></span>
      </div>
    </div>
  </div>

  <!-- iOS å¼ºåˆ¶ PWA æç¤ºï¼ˆiOS é PWA æ¨¡å¼å§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
  <div class="ios-pwa-required">
    <div class="ios-pwa-title">
      <span class="pwa-title-zh">è¯·æ·»åŠ åˆ°ä¸»å±å¹•</span>
      <span class="pwa-title-en">Add to Home Screen Required</span>
    </div>
    <div class="ios-pwa-subtitle">
      <span class="pwa-text-zh">æœ¬æ¸¸æˆéœ€è¦ä»¥åº”ç”¨æ¨¡å¼è¿è¡Œ</span>
      <span class="pwa-text-en">This game requires app mode to run</span>
    </div>
    <div class="ios-pwa-steps">
      <div class="pwa-step">
        <span class="pwa-step-num">1</span>
        <span class="pwa-text-zh">ç‚¹å‡»åº•éƒ¨ <strong>åˆ†äº«</strong> æŒ‰é’® <span class="share-icon">&#xfe52;</span></span>
        <span class="pwa-text-en">Tap <strong>Share</strong> button <span class="share-icon">&#xfe52;</span> below</span>
      </div>
      <div class="pwa-step">
        <span class="pwa-step-num">2</span>
        <span class="pwa-text-zh">é€‰æ‹© <strong>æ·»åŠ åˆ°ä¸»å±å¹•</strong></span>
        <span class="pwa-text-en">Select <strong>Add to Home Screen</strong></span>
      </div>
      <div class="pwa-step">
        <span class="pwa-step-num">3</span>
        <span class="pwa-text-zh">ä»ä¸»å±å¹•æ‰“å¼€æ¸¸æˆ</span>
        <span class="pwa-text-en">Open the game from Home Screen</span>
      </div>
    </div>
  </div>

  <!-- å¹³å°æ£€æµ‹è„šæœ¬ï¼ˆéœ€è¦åœ¨ body æ ‡ç­¾åç«‹å³æ‰§è¡Œï¼‰ -->
  <script>
    (function() {
      var ua = navigator.userAgent;
      if (/iPhone|iPad|iPod/i.test(ua)) {
        document.body.classList.add('is-ios');
      } else if (/Android/i.test(ua)) {
        document.body.classList.add('is-android');
      }
      // æ£€æµ‹ PWA æ¨¡å¼
      if (window.matchMedia('(display-mode: standalone)').matches || navigator.standalone === true) {
        document.body.classList.add('is-pwa');
      }
    })();
  </script>

  <!-- CRT Monitor Wrapper -->
  <div class="monitor-bezel">
    <!-- ECG Panel - å¿ƒç”µå›¾é¢æ¿ -->
    <div class="ecg-panel">
      <div class="ecg-module">
        <div class="ecg-screen">
          <div class="ecg-grid"></div>
          <canvas id="ecgCanvas"></canvas>
        </div>
        <div class="ecg-info">
          <span class="ecg-label ecg-label-zh">æ‚£è€… æˆˆå°”</span>
          <span class="ecg-label ecg-label-en">Patient: Gregor</span>
        </div>
      </div>
    </div>

    <!-- Brand Plate - å“ç‰Œé“­ç‰Œ -->
    <div class="brand-plate">
      <div class="brand-name">Mind Mirror</div>
    </div>

    <div class="crt-screen">

      <!-- CRT Effect Layers -->
      <div class="scanlines"></div>
      <div class="glass-overlay"></div>
      <div class="refresh-line"></div>

      <!-- ========== è¯­è¨€é€‰æ‹©ç•Œé¢ ========== -->
      <div class="lang-select-screen crt-active">
        <div class="lang-select-frame">
          <div class="lang-title">SELECT LANGUAGE</div>
          <div class="lang-title-sub">é€‰æ‹©è¯­è¨€</div>
          <button class="lang-btn" data-lang="en">[  ENGLISH  ]</button>
          <button class="lang-btn" data-lang="zh">[   ä¸­æ–‡    ]</button>
        </div>
      </div>

      <!-- ========== å…‰æ•æ€§è­¦å‘Šç•Œé¢ ========== -->
      <div class="warning-screen crt-active" style="display: none;">
        <div class="warning-frame">
          <div class="warning-title"></div>
          <div class="warning-text"></div>
        </div>
      </div>

      <!-- ========== è€³æœºå»ºè®®ç•Œé¢ ========== -->
      <div class="headphone-screen crt-active" style="display: none;">
        <div class="headphone-frame">
          <div class="headphone-icon">ğŸ§</div>
          <div class="headphone-text"></div>
        </div>
      </div>

      <!-- ========== å¼€åœºç•Œé¢ ========== -->
      <div class="opening-screen crt-active" style="display: none;">
        <div class="opening-frame">
          <!-- å°æ ‡é¢˜ -->
          <div class="opening-subtitle">It's just a</div>

          <!-- ASCII Logo -->
          <div class="opening-logo">
            <pre class="ascii-art">
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â•

â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•
â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—  â•šâ–ˆâ–ˆâ•”â•
â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•   â•šâ•â•
            </pre>
          </div>

          <!-- æŒ‰é’®ç»„ï¼šLogin + Language å¹¶åˆ— -->
          <div class="opening-buttons">
            <button class="opening-btn login-button">Login</button>
            <button class="opening-btn back-to-lang-btn">Language</button>
          </div>
        </div>
      </div>

      <!-- ========== ä¸»åº”ç”¨å®¹å™¨ ========== -->
      <div class="app-container app-hidden">

        <!-- å·¦ä¾§æ  -->
        <div class="left-sidebar">
          <!-- Tabåˆ‡æ¢ -->
          <div class="tab-switch">
            <span class="tab-btn active" data-type="memory">[MEMORY]</span>
            <span class="tab-btn" data-type="file">[FILE]</span>
            <span class="tab-btn" data-type="clue">[CLUE]</span>
          </div>

          <!-- æ–‡ä»¶åˆ—è¡¨ -->
          <div class="file-list">
            <!-- Content populated by JS -->
          </div>

          <!-- ç»Ÿè®¡ä¿¡æ¯ -->
          <div class="statistics">
            <p>Discovered: <span class="stat-number">0</span></p>
          </div>
        </div>

        <!-- å³ä¾§åŒºåŸŸ -->
        <div class="right-area">
          <!-- å¡ç‰‡å†…å®¹åŒº -->
          <div class="card-content-area">
            <!-- æ ‡é¢˜æ  -->
            <div class="title-bar">
              <span class="card-filename"></span>
              <span class="card-timestamp"></span>
            </div>

            <!-- å¡ç‰‡å†…å®¹æ»šåŠ¨åŒº -->
            <div class="card-scroll">
              <!-- æ–‡æœ¬å†…å®¹åŒº -->
              <div class="text-content">
                <!-- Content populated by JS -->
              </div>
            </div>
          </div>

          <!-- è¾“å…¥äº¤äº’åŒº - ä¸‰æ®µå¼å¸ƒå±€ -->
          <div class="input-area">
            <!-- ç³»ç»Ÿè¾“å‡ºåŒº -->
            <div class="system-output">
              <p class="output-line"></p>
              <p class="output-line"></p>
            </div>

            <!-- è¾“å…¥è¡Œ -->
            <div class="input-line">
              <span class="prompt">CAROL@TERMINAL:~$</span>
              <input type="text" class="command-input" placeholder="" />
              <span class="cursor-block"></span>
            </div>

            <!-- çŠ¶æ€æŒ‰é’®æ  -->
            <div class="function-bar">
              <span class="func-btn active" data-mode="search">[SEARCH]</span>
              <span class="func-btn locked" data-mode="sort">[SORT]</span>
              <span class="func-btn locked" data-mode="delete">[DELETE]</span>
              <span class="func-btn" data-mode="reset">[RESET]</span>
            </div>
          </div>
        </div>

      </div>
      <!-- End of app-container -->

    </div>
  </div>
  <!-- End of monitor-bezel -->

  <!-- é‡ç½®ç¡®è®¤å¼¹çª— -->
  <div class="reset-modal-overlay" id="resetModal">
    <div class="reset-modal">
      <div class="reset-modal-text">
        <p class="reset-warning" id="resetWarningText"></p>
      </div>
      <div class="reset-modal-buttons">
        <button class="reset-btn confirm" id="resetConfirmBtn">[CONFIRM]</button>
        <button class="reset-btn cancel" id="resetCancelBtn">[CANCEL]</button>
      </div>
    </div>
  </div>

  <!-- å¼€åœºç•Œé¢è„šæœ¬ -->
  <script src="./js/effects/boot-controller.js"></script>
  <script src="./js/lang-select.js"></script>
  <script src="./js/opening.js"></script>

  <!-- åŠ è½½æ¸¸æˆæ¨¡å— -->
  <!-- éŸ³é¢‘ç®¡ç†å™¨ - å¿…é¡»æœ€æ—©åŠ è½½ -->
  <script src="./js/audio.js"></script>

  <!-- æ•°æ®æ–‡ä»¶ç”± lang-select.js æ ¹æ®è¯­è¨€åŠ¨æ€åŠ è½½ -->
  <script src="./js/state.js"></script>
  <script src="./js/cards.js"></script>
  <script src="./js/search.js"></script>
  <script src="./js/unlock.js"></script>
  <script src="./js/render.js"></script>
  <script src="./js/scramble.js"></script>
  <script src="./js/memory-decay.js"></script>
  <script src="./js/reading-lock.js"></script>

  <!-- åˆ é™¤åŠ¨ç”»ç³»ç»Ÿ -->
  <script src="./js/lib/powerglitch.min.js"></script>
  <script src="./js/effects/deletion-controller.js"></script>

  <!-- å­—å¹•å’Œç»“æŸç•Œé¢ç³»ç»Ÿ -->
  <script src="./js/subtitle.js"></script>
  <script src="./js/ending.js"></script>

  <!-- è°ƒè¯•æ¨¡å¼è·³è¿‡å¼€åœºï¼ˆå¯é€‰ï¼‰ -->
  <script src="./js/debug-skip.js"></script>

  <script src="./js/app.js"></script>
  <script src="./js/ecg.js"></script>

  <!-- åˆå§‹åŒ–å¼€åœºç•Œé¢ -->
  <script>
    // æ£€æµ‹ URL å‚æ•°æ˜¯å¦åŒ…å« skip=1
    const urlParams = new URLSearchParams(window.location.search);
    const skipOpeningByUrl = urlParams.get('skip') === '1';

    // è°ƒè¯•æ¨¡å¼è·³è¿‡ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    const debugSkip = window.DEBUG_SKIP_OPENING || skipOpeningByUrl;

    if (debugSkip) {
      // è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡æ‰€æœ‰å¼€åœºæµç¨‹
      console.log('[Init] Debug skip mode enabled');
      window.openingActive = false;

      document.addEventListener('DOMContentLoaded', async () => {
        document.querySelector('.lang-select-screen')?.classList.add('hidden');
        document.querySelector('.opening-screen').style.display = 'none';

        // åŠ è½½æ¸¸æˆæ•°æ®ï¼ˆä½¿ç”¨å·²å­˜å‚¨çš„è¯­è¨€æˆ–é»˜è®¤è‹±æ–‡ï¼‰
        const lang = LangSelect.getCurrentLang();
        console.log(`[Init] Debug: Loading ${lang} game data...`);
        try {
          await LangSelect.loadGameData(lang);
        } catch (error) {
          console.error('[Init] Failed to load game data:', error);
          return;
        }

        const appContainer = document.querySelector('.app-container');
        if (appContainer) {
          appContainer.classList.remove('app-hidden');
          appContainer.classList.add('app-fade-in');
        }
        console.log('[Init] Debug: Game starting directly...');
      });
    } else {
      // æ­£å¸¸æµç¨‹ï¼šæ£€æŸ¥è¯­è¨€å’Œå­˜æ¡£çŠ¶æ€
      const skipCondition = LangSelect.checkSkipCondition();
      console.log('[Init] Skip condition:', skipCondition);

      if (skipCondition.skip && skipCondition.skipOpening) {
        // æœ‰å­˜æ¡£ï¼šè·³è¿‡è¯­è¨€é€‰æ‹©å’ŒOpeningï¼Œç›´æ¥è¿›å…¥æ¸¸æˆ
        console.log('[Init] Saved game detected, skipping to main game...');
        // ã€é‡è¦ã€‘å…ˆè®¾ç½®ä¸º trueï¼Œé˜»æ­¢ app.js ä¸­çš„è‡ªåŠ¨ initApp() è°ƒç”¨
        // ç­‰æ•°æ®åŠ è½½å®Œæˆåå†æ‰‹åŠ¨è°ƒç”¨
        window.openingActive = true;

        document.addEventListener('DOMContentLoaded', async () => {
          document.querySelector('.lang-select-screen')?.classList.add('hidden');
          document.querySelector('.opening-screen').style.display = 'none';

          // åŠ è½½å¯¹åº”è¯­è¨€çš„æ¸¸æˆæ•°æ®
          const lang = skipCondition.lang;
          console.log(`[Init] Loading ${lang} game data...`);
          try {
            await LangSelect.loadGameData(lang);
          } catch (error) {
            console.error('[Init] Failed to load game data:', error);
            return;
          }

          // æ•°æ®åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºä¸»ç•Œé¢
          const appContainer = document.querySelector('.app-container');
          if (appContainer) {
            appContainer.classList.remove('app-hidden');
            appContainer.classList.add('app-fade-in');
          }

          // ã€å…³é”®ã€‘æ•°æ®åŠ è½½å®Œæˆåï¼Œæ‰‹åŠ¨è°ƒç”¨ initApp()
          console.log('[Init] Game data loaded, initializing app...');
          window.openingActive = false;
          if (typeof initApp === 'function') {
            initApp();
          }

          // ã€å­˜æ¡£æ¢å¤ã€‘å¯åŠ¨èƒŒæ™¯éŸ³ä¹
          if (window.audioManager) {
            // ä»å­˜æ¡£è¯»å–BGMçŠ¶æ€
            let bgmToPlay = 'Atmosphere';  // é»˜è®¤BGM
            const savedState = localStorage.getItem('gameState');

            if (savedState) {
              try {
                const state = JSON.parse(savedState);
                // ä¼˜å…ˆä½¿ç”¨å­˜æ¡£ä¸­ä¿å­˜çš„BGM
                if (state.current_bgm) {
                  bgmToPlay = state.current_bgm;
                }
              } catch (e) {
                console.warn('[Init] Failed to parse saved state for BGM selection');
              }
            }

            console.log(`[Init] Will start BGM: ${bgmToPlay} (after user interaction)`);

            // æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼šéœ€è¦ç”¨æˆ·é¦–æ¬¡äº¤äº’åæ‰èƒ½æ’­æ”¾
            let bgmStarted = false;
            const startBGM = () => {
              if (bgmStarted) return;
              bgmStarted = true;
              console.log(`[Init] User interaction detected, starting ${bgmToPlay} BGM...`);
              // Atmosphere ä½¿ç”¨äº¤å‰æ·¡å…¥æ·¡å‡ºå¾ªç¯æ’­æ”¾ï¼Œå…¶ä»–BGMæ™®é€šæ’­æ”¾
              if (bgmToPlay === 'Atmosphere') {
                audioManager.playMusicWithLoopFade('Atmosphere', 2000, 3000);  // 2ç§’åˆå§‹æ·¡å…¥ï¼Œ3ç§’äº¤å‰æ·¡å…¥æ·¡å‡º
              } else {
                audioManager.playMusic(bgmToPlay, 1, 2000);  // 2ç§’æ·¡å…¥
              }
              // æ¸…ç†ç›‘å¬å™¨
              document.removeEventListener('click', startBGM);
              document.removeEventListener('keydown', startBGM);
            };

            document.addEventListener('click', startBGM, { once: true });
            document.addEventListener('keydown', startBGM, { once: true });
          }
        });
      } else if (skipCondition.skip && !skipCondition.skipOpening) {
        // æœ‰è¯­è¨€è®¾ç½®ä½†æ— å­˜æ¡£ï¼šè·³è¿‡è¯­è¨€é€‰æ‹©ï¼Œæ˜¾ç¤ºOpening
        console.log('[Init] Language selected, showing Opening...');
        window.openingActive = true;

        document.addEventListener('DOMContentLoaded', async () => {
          // éšè—è¯­è¨€é€‰æ‹©ï¼Œæ˜¾ç¤ºOpening
          document.querySelector('.lang-select-screen')?.classList.add('hidden');

          // å…ˆåŠ è½½å¯¹åº”è¯­è¨€çš„æ¸¸æˆæ•°æ®
          const lang = skipCondition.lang;
          console.log(`[Init] Loading ${lang} game data...`);
          try {
            await LangSelect.loadGameData(lang);
          } catch (error) {
            console.error('[Init] Failed to load game data:', error);
            return;
          }

          // è®¾ç½®bodyè¯­è¨€ç±»åï¼ˆç”¨äºopeningç•Œé¢çš„è¯­è¨€åˆ‡æ¢æ˜¾ç¤ºï¼‰
          document.body.classList.remove('lang-zh', 'lang-en');
          document.body.classList.add(`lang-${lang}`);

          const openingScreen = document.querySelector('.opening-screen');
          openingScreen.style.display = 'flex';

          // åˆå§‹åŒ–Opening
          const opening = new OpeningScreen({
            fadeOutDuration: 1000,
            bootDelay: 500,
            onComplete: () => {
              console.log('[Init] Opening completed, starting game...');
              window.openingActive = false;
              if (typeof initApp === 'function') {
                initApp();
              }
            }
          });
          opening.init();
        });
      } else {
        // é¦–æ¬¡è®¿é—®ï¼šæ˜¾ç¤ºè¯­è¨€é€‰æ‹©ç•Œé¢
        // æ•°æ®åŠ è½½ç”± LangSelect.selectLanguage() å†…éƒ¨å¤„ç†
        console.log('[Init] First visit, showing language selection...');
        window.openingActive = true;

        document.addEventListener('DOMContentLoaded', () => {
          // è¯­è¨€é€‰æ‹©ç•Œé¢é»˜è®¤æ˜¾ç¤ºï¼ŒOpeningé»˜è®¤éšè—

          // åˆå§‹åŒ–è¯­è¨€é€‰æ‹©
          const langSelect = new LangSelect({
            fadeOutDuration: 400,
            onLanguageSelected: (lang) => {
              console.log(`[Init] Language selected: ${lang}, initializing Opening...`);

              // åˆå§‹åŒ–Openingï¼ˆæ•°æ®å·²åœ¨ selectLanguage ä¸­åŠ è½½ï¼‰
              const opening = new OpeningScreen({
                fadeOutDuration: 1000,
                bootDelay: 500,
                onComplete: () => {
                  console.log('[Init] Opening completed, starting game...');
                  window.openingActive = false;
                  if (typeof initApp === 'function') {
                    initApp();
                  }
                }
              });
              opening.init();
            }
          });
          langSelect.init();
          console.log('[Init] Language selection screen ready');
        });
      }
    }
  </script>

  <!-- ç®€å•é˜²æŠ¤ï¼šç¦ç”¨å³é”®å’Œå¼€å‘è€…å·¥å…·å¿«æ·é”® -->
  <script>
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (e.key === 'F12' ||
          (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i')) ||
          (e.ctrlKey && (e.key === 'U' || e.key === 'u')) ||
          (e.ctrlKey && (e.key === 'S' || e.key === 's'))) {
        e.preventDefault();
      }
    });
  </script>

  <!-- Service Worker æ³¨å†Œ -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }
  </script>

</body>

</html>